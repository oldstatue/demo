<!DOCTYPE html>
<html>

<head>
		<link rel="stylesheet" type="text/css" href="style.css" />
		<title> Poem Demo </title>
</head>

<body>

<div id="header">
	<div id="form-wrapper">
		<form style="display: inline; margin-right: 50px;">
			<p style="display: inline;">Search by title: </p>
			<input type="text" id="title-search">
			<button onclick="update_filters('title-search')">Search</button>
			<button onclick="clear_filters('title-search')">Clear</button>
		</form>

		<form style="display: inline; margin-right: 50px">
			<p style="display: inline;">Search by poet: </p>
			<input type="text" id="author-search">
			<button onclick="update_filters('author-search')">Search</button>
			<button onclick="clear_filters('author-search')">Clear</button>
		</form>
		<button style="right: 0px" onclick="clear_filters('all')">Clear All</button>
	</div>
</div>

<div id="main-body"></div>

<script type="text/javascript">
	function debug_msg (msg) {
		if (debugFlag) {
			console.log(msg);
		}
	}

	function update_filters (filter) {
		if (filter == "author-search") {
			authorFilter = document.getElementById(filter).value;
		} else if (filter == "title-search") {
			titleFilter = document.getElementById(filter).value;
		}

		filter_poems();
	}

	function clear_filters (filter) {
		if (filter == "author-search" || filter == "all") {
			document.getElementById("author-search").value = "";
			authorFilter = "";
		}

		if (filter == "title-search" || filter == "all") {
			document.getElementById("title-search").value = "";
			titleFilter = "";
		}

		filter_poems();
	}

	function filter_poems () {
		mainBody.innerHTML = "";

		var titleRegex = RegExp(titleFilter.toLowerCase());
		var authorRegex = RegExp(authorFilter.toLowerCase());

		for (var a = 0; a < authorList.length; a++) {
			if (authorRegex.test(authorList[a].name.toLowerCase())) {
				console.log(authorList[a]);
				console.log(authorList[a].html);
				let poemDiv = authorList[a].html.querySelector('#poem-container');
				console.log(poemDiv);
				poemDiv.innerHTML = "";
				poemDiv.style.height = "auto";

				let atLeastOneMatch = false;

				for (var p = 0; p < authorList[a].poemList.length; p++) {
					if (titleRegex.test(authorList[a].poemList[p].title.toLowerCase())) {
						atLeastOneMatch = true;
						
						let poemBody = authorList[a].poemList[p].html.querySelector('#poem-body');
						poemBody.style.height = "0px";
						poemDiv.appendChild(authorList[a].poemList[p].html);
						
					}
				}

				if (atLeastOneMatch) {
					mainBody.appendChild(authorList[a].html);
				}
			}
		}
	}

	function read_xml (xmlDoc) {
		var poems = xmlDoc.getElementsByTagName("poem");

		for (var p = 0; p < poems.length; p++) {
			let newPoem = {
				title: xmlDoc.getElementsByTagName("title")[p].childNodes[0].nodeValue,
				text: xmlDoc.getElementsByTagName("text")[p].childNodes[0].nodeValue
			}

			let foundMatch = false;
			let testName = xmlDoc.getElementsByTagName("author")[p].childNodes[0].nodeValue;  
			
			//check if the poem's author already exists, and if so add the poem to that author
			for (var a = 0; a < authorList.length; a++) {
				if (authorList[a].name == testName) {
					authorList[a].poemList.push(newPoem);
					foundMatch = true;
				}
			}

			//if the poet doesn't already exist, create a new poet and add the poem to them 
			if (!foundMatch) {
				let splitName = name.split(" ");
				let lastName = splitName[splitName.length - 1].toLowerCase();
				
				authorList.push({
					name: testName,
					lastName: lastName,
					poemList: [newPoem]
				});
			}
		}
	}

	function generate_html () {
		authorList = alphabetise(authorList, "lastName");
		
		for (var a = 0; a < authorList.length; a++) {
			authorList[a].poemList = alphabetise(authorList[a].poemList, "title");

			let newAuthDiv = document.createElement('div');

			let newAuthName = document.createElement('a');
			newAuthName.innerHTML = authorList[a].name;
			newAuthName.href = "#";
			newAuthName.style.textDecoration = "underline";
			newAuthDiv.appendChild(newAuthName);

			let poemDiv = document.createElement('div');
			poemDiv.id = "poem-container";
			poemDiv.style.height = "auto";
			
			newAuthName.onclick = function (e) {
				e.preventDefault();

				if (poemDiv.style.height == "0px") {
					poemDiv.style.height = "auto";
				} else {	
					poemDiv.style.height = "0px";
				}
			};
			
			for (var p = 0; p  < authorList[a].poemList.length; p++) {
				let newPoemDiv = document.createElement('div');

				let newTitle = document.createElement('a');
				newTitle.innerHTML = authorList[a].poemList[p].title;
				newTitle.href = "#";
				newPoemDiv.appendChild(newTitle);

				let newText = document.createElement('p');
				newText.innerHTML = "<br />" + authorList[a].poemList[p].text;
				newText.id = "poem-body";
				newText.style.height = "0px";
				newPoemDiv.appendChild(newText);

				newTitle.onclick = function (e) {
					e.preventDefault();

					if (newText.style.height == "0px") {
						newText.style.height = newText.scrollHeight + "px";
					} else {
						newText.style.height = "0px";
					}
				}
			
				authorList[a].poemList[p].html = newPoemDiv;
				poemDiv.appendChild(authorList[a].poemList[p].html);
			}

			newAuthDiv.appendChild(poemDiv);
			newAuthDiv.appendChild(document.createElement('br'));
			console.log("generate new auth div:", newAuthDiv);
			authorList[a].html = newAuthDiv;
			console.log("new author list html:", authorList[a].html);
			mainBody.appendChild(authorList[a].html);
		}
	}

	function alphabetise (list, property) {
		return list.sort(function (a, b) {
			if (a[property] > b[property]) {
				return 1;
			} else if (b[property] > a[property]) {
				return -1;
			} 
			
			return 0;
		});
	}

	var debugFlag = true;
	var mainBody = document.getElementById('main-body');
	var authorList = [];
	var titleFilter = "";
	var authorFilter = "";

	debug_msg("Requesting XML");
	var xmlReq = new XMLHttpRequest();
	xmlReq.open("GET", "./log.xml", true);
	xmlReq.send();
	xmlReq.onload = function () {
		debug_msg("XML loaded succesfully");
		read_xml(xmlReq.responseXML);
		generate_html();
	}
</script>

</body>

</html>



